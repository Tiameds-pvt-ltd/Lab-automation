#name: CI/CD Pipeline
#
#on:
#  push:
#    branches:
#      - main
#  pull_request:
#    branches:
#      - main
#  workflow_dispatch:
#
#jobs:
#  build-and-deploy:
#    runs-on: ubuntu-latest
#
#    steps:
#      # Step 1: Checkout code
#      - name: Checkout code
#        uses: actions/checkout@v4
#
#      # Step 2: Set up JDK 17 for Maven
#      - name: Set up JDK 17
#        uses: actions/setup-java@v4
#        with:
#          java-version: '17'
#          distribution: 'temurin'
#          cache: maven
#
#      # Step 3: Build and Package Spring Boot Application
#      - name: Build Application (Skip Tests)
#        run: mvn clean package -Pci -Dmaven.test.skip=true
#        env:
#          SPRING_PROFILES_ACTIVE: ci
#          JWT_SECRET: dummy-secret-for-build-only
#
#      # Step 4: Security Scanning (OWASP non-blocking)
#      - name: Run Security Scans
#        continue-on-error: true
#        run: |
#          echo "üîí Starting security scanning..."
#
#          echo "üì¶ Running OWASP Dependency-Check (non-blocking, no API key)..."
#          mkdir -p dependency-check-data
#          mvn org.owasp:dependency-check-maven:10.0.4:check \
#            -DdataDirectory=dependency-check-data \
#            -Dautoupdate=false \
#            -Dnvd.api.disabled=true || echo "‚ö†Ô∏è OWASP scan skipped or completed with issues"
#
#          echo "üîç Running SpotBugs security analysis..."
#          mvn spotbugs:check || echo "‚ö†Ô∏è SpotBugs scan completed with issues"
#
#          echo "‚úÖ Security scans completed!"
#
#      # Step 5: SonarQube Analysis (Optional)
#      - name: SonarQube Analysis
#        if: false  # Set to true in GitHub Actions variables if you want to enable SonarQube
#        continue-on-error: true
#        run: |
#          echo "üîç Running SonarQube analysis..."
#          mvn sonar:sonar \
#            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
#            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }} \
#            -Dsonar.login=${{ secrets.SONAR_TOKEN }} \
#            -Dsonar.qualitygate.wait=true || echo "‚ö†Ô∏è SonarQube analysis completed with issues"
#          echo "‚úÖ SonarQube analysis completed!"
#
#      # Step 6: Start Application for ZAP Testing
#      - name: Start Application for ZAP
#        if: false  # Set to true to enable ZAP testing
#        continue-on-error: true
#        run: |
#          echo "üöÄ Starting application for ZAP testing with H2 database..."
#          mvn spring-boot:run -Dspring-boot.run.profiles=ci &
#          APP_PID=$!
#          echo "APP_PID=$APP_PID" >> $GITHUB_ENV
#          echo "‚è≥ Waiting for application to start..."
#          sleep 60
#          echo "‚úÖ Application started!"
#        env:
#          SPRING_PROFILES_ACTIVE: ci
#          JWT_SECRET: test-jwt-secret-for-zap-scanning
#
#      # Step 7: OWASP ZAP Baseline Scan
#      - name: OWASP ZAP Baseline Scan
#        if: false  # Set to true to enable ZAP baseline scan
#        continue-on-error: true
#        uses: zaproxy/action-baseline@v0.7.0
#        with:
#          target: 'http://localhost:8080/api/v1'
#          rules_file_name: '.zap/rules.tsv'
#          cmd_options: '-a'
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#
#      # Step 8: OWASP ZAP Full Scan
#      - name: OWASP ZAP Full Scan
#        if: false  # Set to true to enable ZAP full scan
#        continue-on-error: true
#        uses: zaproxy/action-full-scan@v0.4.0
#        with:
#          target: 'http://localhost:8080/api/v1'
#          rules_file_name: '.zap/rules.tsv'
#          cmd_options: '-a'
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#
#      # Step 9: Stop Application
#      - name: Stop Application
#        if: false  # Set to true to enable application shutdown after ZAP
#        continue-on-error: true
#        run: |
#          echo "üõë Stopping application..."
#          if [ ! -z "$APP_PID" ]; then
#            kill $APP_PID || echo "Application already stopped"
#          fi
#          pkill -f spring-boot:run || echo "Application already stopped"
#          echo "‚úÖ Application stopped!"
#
#      # Step 10: Configure AWS credentials
#      - name: Configure AWS credentials
#        uses: aws-actions/configure-aws-credentials@v3
#        with:
#          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#          aws-region: ${{ secrets.AWS_REGION }}
#
#      # Step 11: Log in to Amazon ECR
#      - name: Log in to Amazon ECR
#        id: ecr-login
#        uses: aws-actions/amazon-ecr-login@v2
#
#      # Step 12: Build, Tag, and Push Docker Image to Amazon ECR
#      - name: Build, Tag, and Push Docker Image to Amazon ECR
#        env:
#          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
#          IMAGE_TAG: ${{ github.sha }}
#          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
#        run: |
#          echo "Building Docker image $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
#          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
#          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
#
#      # Step 13: Update ECS Task Definition
#      - name: Update ECS Task Definition
#        id: update-task-def
#        uses: aws-actions/amazon-ecs-render-task-definition@v1
#        with:
#          task-definition: deploy/tiameds-lab-task-defination.json
#          container-name: tiamed-lab-test
#          image: ${{ steps.ecr-login.outputs.registry }}/${{ secrets.ECR_REPOSITORY }}:${{ github.sha }}
#
#      # Step 14: Deploy to ECS
#      - name: Deploy to ECS
#        uses: aws-actions/amazon-ecs-deploy-task-definition@v2
#        with:
#          task-definition: ${{ steps.update-task-def.outputs.task-definition }}
#          service: ${{ secrets.ECS_SERVICE }}
#          cluster: ${{ secrets.ECS_CLUSTER }}
#          wait-for-service-stability: true
#
#      #
#      # Step 15: Post-deployment Health Check
##      - name: Health Check
##        env:
##          SERVICE_URL: ${{ secrets.SERVICE_URL }}
##        run: |
##          echo "Checking service health at $SERVICE_URL"
##          for i in {1..10}; do
##            STATUS=$(curl -s -o /dev/null -w '%{http_code}' $SERVICE_URL)
##            if [ "$STATUS" -eq 200 ]; then
##              echo "Service is healthy!"
##              exit 0
##            fi
##            echo "Service not healthy. Retrying in 10 seconds..."
##            sleep 10
##          done
##          echo "Service health check failed."
##          exit 1



name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up JDK 17 for Maven
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # Step 3: Build and Package Spring Boot Application
      - name: Build Application (Skip Tests)
        run: mvn clean package -Pci -Dmaven.test.skip=true
        env:
          SPRING_PROFILES_ACTIVE: ci
          JWT_SECRET: dummy-secret-for-build-only

      ##################################################################
      #      SECURITY SCANS COMMENTED OUT FOR FASTER DEPLOYMENT       #
      ##################################################################

      #      # Step 4: Security Scanning (OWASP non-blocking)
      #      - name: Run Security Scans
      #        continue-on-error: true
      #        run: |
      #          echo "üîí Starting security scanning..."
      #          echo "üì¶ Running OWASP Dependency-Check..."
      #          mkdir -p dependency-check-data
      #          mvn org.owasp:dependency-check-maven:10.0.4:check \
      #            -DdataDirectory=dependency-check-data \
      #            -Dautoupdate=false \
      #            -Dnvd.api.disabled=true || echo "‚ö†Ô∏è OWASP scan skipped or completed with issues"
      #          echo "üîç Running SpotBugs..."
      #          mvn spotbugs:check || echo "‚ö†Ô∏è SpotBugs issues found"
      #          echo "‚úÖ Security scans completed!"

      #      # Step 5: SonarQube Analysis
      #      - name: SonarQube Analysis
      #        if: false
      #        continue-on-error: true
      #        run: |
      #          echo "üîç Running SonarQube analysis..."
      #          mvn sonar:sonar \
      #            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
      #            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }} \
      #            -Dsonar.login=${{ secrets.SONAR_TOKEN }} \
      #            -Dsonar.qualitygate.wait=true || echo "‚ö†Ô∏è SonarQube completed with issues"
      #          echo "‚úÖ SonarQube analysis completed!"

      #      # Step 6: Start Application for ZAP Testing
      #      - name: Start Application for ZAP
      #        if: false
      #        continue-on-error: true
      #        run: |
      #          echo "üöÄ Starting application for ZAP testing..."
      #          mvn spring-boot:run -Dspring-boot.run.profiles=ci &
      #          APP_PID=$!
      #          echo "APP_PID=$APP_PID" >> $GITHUB_ENV
      #          echo "‚è≥ Waiting..."
      #          sleep 60
      #          echo "‚úÖ Application started!"

      #      # Step 7: OWASP ZAP Baseline Scan
      #      - name: OWASP ZAP Baseline Scan
      #        if: false
      #        continue-on-error: true
      #        uses: zaproxy/action-baseline@v0.7.0
      #        with:
      #          target: 'http://localhost:8080/api/v1'
      #          rules_file_name: '.zap/rules.tsv'
      #          cmd_options: '-a'

      #      # Step 8: OWASP ZAP Full Scan
      #      - name: OWASP ZAP Full Scan
      #        if: false
      #        continue-on-error: true
      #        uses: zaproxy/action-full-scan@v0.4.0
      #        with:
      #          target: 'http://localhost:8080/api/v1'
      #          rules_file_name: '.zap/rules.tsv'
      #          cmd_options: '-a'

      #      # Step 9: Stop Application
      #      - name: Stop Application
      #        if: false
      #        continue-on-error: true
      #        run: |
      #          echo "üõë Stopping application..."
      #          if [ ! -z "$APP_PID" ]; then
      #            kill $APP_PID || echo "Application already stopped"
      #          fi
      #          pkill -f spring-boot:run || echo "Already stopped"
      #          echo "‚úÖ Application stopped!"

      ##################################################################
      #                     DEPLOYMENT STEPS BELOW                    #
      ##################################################################

      # Step 10: Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # Step 11: Log in to Amazon ECR
      - name: Log in to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      # Step 12: Build, Tag, and Push Docker Image to Amazon ECR
      - name: Build, Tag, and Push Docker Image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
        run: |
          echo "Building Docker image $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      # Step 13: Update ECS Task Definition
      - name: Update ECS Task Definition
        id: update-task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: deploy/tiameds-lab-task-defination.json
          container-name: tiamed-lab-test
          image: ${{ steps.ecr-login.outputs.registry }}/${{ secrets.ECR_REPOSITORY }}:${{ github.sha }}

      # Step 14: Deploy to ECS
      - name: Deploy to ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v2
        with:
          task-definition: ${{ steps.update-task-def.outputs.task-definition }}
          service: ${{ secrets.ECS_SERVICE }}
          cluster: ${{ secrets.ECS_CLUSTER }}
          wait-for-service-stability: true